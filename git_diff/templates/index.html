<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>git-diff</title>
<style>
/* ================================================================
   THEMES
================================================================ */
:root,[data-theme="dark"]{
  --bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--bg5:#3d444d;
  --border:#30363d;--border2:#21262d;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;
  --link:#58a6ff;
  --add-bg:#0d2419;--add-hl:#1a4731;--add-text:#3fb950;
  --del-bg:#2d0f0f;--del-hl:#6e1a1a;--del-text:#f85149;
  --hunk-bg:#1c2128;--accent:#238636;--accent2:#1f6feb;--accent3:#8957e5;
  --yellow:#d29922;--orange:#db6d28;--shadow:rgba(0,0,0,.4);--scrollbar:#30363d;
}
[data-theme="light"]{
  --bg:#ffffff;--bg2:#f6f8fa;--bg3:#eaeef2;--bg4:#d0d7de;--bg5:#afb8c1;
  --border:#d0d7de;--border2:#eaeef2;--text:#1f2328;--text2:#636c76;--text3:#8c959f;
  --link:#0969da;--add-bg:#e6ffec;--add-hl:#abf2bc;--add-text:#1a7f37;
  --del-bg:#ffebe9;--del-hl:#ffc1ba;--del-text:#cf222e;
  --hunk-bg:#ddf4ff;--accent:#1a7f37;--accent2:#0969da;--accent3:#6639ba;
  --yellow:#9a6700;--orange:#953800;--shadow:rgba(0,0,0,.12);--scrollbar:#d0d7de;
}
[data-theme="amoled"]{
  --bg:#000;--bg2:#080808;--bg3:#111;--bg4:#1a1a1a;--bg5:#222;
  --border:#1f1f1f;--border2:#111;--text:#fff;--text2:#9e9e9e;--text3:#616161;
  --link:#64b5f6;--add-bg:#001a00;--add-hl:#003300;--add-text:#66bb6a;
  --del-bg:#1a0000;--del-hl:#330000;--del-text:#ef5350;
  --hunk-bg:#000a11;--accent:#2e7d32;--accent2:#1565c0;--accent3:#6a1b9a;
  --yellow:#f9a825;--orange:#e65100;--shadow:rgba(0,0,0,.8);--scrollbar:#1a1a1a;
}

/* ================================================================
   RESET & BASE
================================================================ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'SFMono-Regular',Consolas,'Liberation Mono',Menlo,monospace;font-size:14px;line-height:1.5}
a{color:var(--link);text-decoration:none}
a:hover{text-decoration:underline}
button{font-family:inherit;cursor:pointer;border:none;background:none}
input,select{font-family:inherit}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:3px}
::selection{background:rgba(31,111,235,.35)}

/* ================================================================
   LAYOUT
================================================================ */
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

/* TOP BAR */
.topbar{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 14px;height:50px;
  display:flex;align-items:center;gap:10px;
  flex-shrink:0;z-index:200;
}
.brand{display:flex;align-items:center;gap:7px;font-size:14px;font-weight:700;color:var(--text);white-space:nowrap;user-select:none;cursor:pointer}
.brand svg{color:var(--add-text)}
.topbar-pill{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:3px 10px;border-radius:20px;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.topbar-branch{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--link)}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:6px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:6px;font-size:12px;font-weight:500;transition:all .12s;white-space:nowrap;font-family:inherit;cursor:pointer}
.btn:hover{background:var(--bg4);border-color:var(--text3)}
.btn.primary{background:var(--accent);border-color:#2ea043;color:#fff}
.btn.primary:hover{filter:brightness(1.1)}
.btn.sm{padding:3px 8px;font-size:11px}
.btn.icon{padding:5px 7px}
.btn.active-btn{background:var(--bg4);border-color:var(--text3)}
.btn svg{flex-shrink:0}

/* THEME SWITCHER */
.theme-toggle{display:flex;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:2px;gap:2px}
.theme-opt{padding:3px 9px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;color:var(--text3);transition:all .15s;border:none;background:none;font-family:inherit}
.theme-opt.active{background:var(--bg);color:var(--text);box-shadow:0 1px 3px var(--shadow)}

/* BODY */
.body{display:flex;flex:1;overflow:hidden;min-height:0}

/* SIDEBAR */
.sidebar{width:260px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .2s ease}
.sidebar.collapsed{width:0;border:none;overflow:hidden}
.snav{display:flex;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.snav-tab{flex:1;padding:9px 4px;text-align:center;cursor:pointer;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid transparent;transition:all .12s}
.snav-tab:hover{color:var(--text);background:var(--bg3)}
.snav-tab.active{color:var(--text);border-bottom-color:var(--accent2)}
.sidebar-body{flex:1;overflow-y:auto;overflow-x:hidden}

/* MAIN */
.main{flex:1;overflow-y:auto;padding:16px 20px;min-width:0}

/* ================================================================
   DIFF TOOLBAR
================================================================ */
.diff-toolbar{display:flex;align-items:center;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.toolbar-group{display:flex;align-items:center;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:2px;gap:1px}
.toolbar-group .btn{background:none;border:none;padding:4px 8px;border-radius:4px;font-size:11px}
.toolbar-group .btn:hover{background:var(--bg4)}
.fs-indicator{font-size:11px;color:var(--text2);padding:0 6px;min-width:34px;text-align:center;user-select:none;line-height:1.8}

/* ================================================================
   SEARCH
================================================================ */
.search-bar{padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0}
.search-input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:6px;font-size:12px;transition:border-color .12s;font-family:inherit}
.search-input:focus{outline:none;border-color:var(--accent2)}

/* ================================================================
   STATS CARDS
================================================================ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:16px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;cursor:pointer;transition:border-color .12s,transform .1s}
.stat-card:hover{border-color:var(--text3);transform:translateY(-1px)}
.stat-card .lbl{font-size:10px;color:var(--text2);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px;font-weight:700}
.stat-card .val{font-size:22px;font-weight:800;line-height:1.1;margin-bottom:1px}

/* ================================================================
   CONTENT TABS
================================================================ */
.ctabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.ctab{padding:8px 14px;cursor:pointer;font-size:13px;color:var(--text2);border-bottom:2px solid transparent;transition:all .12s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.ctab:hover{color:var(--text)}
.ctab.active{color:var(--text);border-bottom-color:var(--accent2)}
.ctab .badge{font-size:10px;background:var(--bg3);padding:1px 6px;border-radius:12px;color:var(--text2)}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* ================================================================
   DIFF VIEWER - MOBILE FIRST
   THE KEY FIX: diff-body handles horizontal scroll as ONE unit,
   lines never scroll individually
================================================================ */
.diff-file{background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden}
.diff-file-hdr{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg3);border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;user-select:none}
.diff-file-hdr:hover{background:var(--bg4)}
.diff-file-hdr .fpath{flex:1;font-size:12px;color:var(--text);font-weight:500;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.diff-file-hdr .fstats{display:flex;align-items:center;gap:5px;flex-shrink:0}
.pill{padding:2px 6px;border-radius:10px;font-size:11px;font-weight:700}
.pill.add{background:rgba(63,185,80,.15);color:var(--add-text)}
.pill.del{background:rgba(248,81,73,.15);color:var(--del-text)}
.pill.na{background:rgba(139,148,158,.12);color:var(--text3)}
.fstatus{font-size:10px;font-weight:800;padding:2px 5px;border-radius:4px}
.fstatus.A{background:rgba(63,185,80,.2);color:var(--add-text)}
.fstatus.M{background:rgba(31,111,235,.2);color:var(--link)}
.fstatus.D{background:rgba(248,81,73,.2);color:var(--del-text)}
.fstatus.R{background:rgba(210,153,34,.2);color:var(--yellow)}
.fstatus.C{background:rgba(137,87,229,.2);color:var(--accent3)}

/* CRITICAL: one scroll container for whole diff block */
.diff-body{overflow-x:auto;overflow-y:visible;-webkit-overflow-scrolling:touch}
.diff-inner{min-width:max-content;width:100%}

/* WRAP MODE: disable per-file scroll, let lines wrap */
.wrap-mode .diff-inner{min-width:unset;width:100%}
.wrap-mode .diff-body{overflow-x:hidden}
.wrap-mode .lc{white-space:pre-wrap !important;word-break:break-all}

.hunk-header{background:var(--hunk-bg);border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:3px 12px;font-size:11px;color:var(--text3);display:flex;align-items:center;gap:8px}
.hunk-header .range{color:var(--link)}

/* LINE ROWS */
.dl{display:flex;min-height:20px;position:relative}
.dl:hover{filter:brightness(1.07)}
.dl:hover .clb{opacity:1}
.ln{width:42px;text-align:right;padding:0 6px 0 4px;color:var(--text3);user-select:none;font-size:11px;flex-shrink:0;border-right:1px solid var(--border2);line-height:20px}
.lc{flex:1;padding:0 8px;white-space:pre;line-height:20px;word-break:normal}
.dl.add{background:var(--add-bg)}
.dl.add .ln{background:var(--add-bg);color:var(--add-text)}
.dl.del{background:var(--del-bg)}
.dl.del .ln{background:var(--del-bg);color:var(--del-text)}
.dl.ctx .ln{background:var(--bg2)}
.dl.ctx .lc{color:var(--text2)}
.sign{display:inline-block;width:14px;user-select:none;font-weight:700;color:var(--text3)}
.dl.add .sign{color:var(--add-text)}
.dl.del .sign{color:var(--del-text)}
.binary-msg{padding:16px;text-align:center;color:var(--text2);font-size:13px}

/* COPY LINE BUTTON */
.clb{position:absolute;right:6px;top:50%;transform:translateY(-50%);opacity:0;background:var(--bg4);border:1px solid var(--border);color:var(--text2);padding:1px 5px;border-radius:4px;font-size:10px;cursor:pointer;transition:opacity .1s;z-index:1;white-space:nowrap;font-family:inherit}
.clb:hover{color:var(--text);background:var(--bg5)}

/* LARGE FILE NOTICE */
.lf-notice{background:rgba(210,153,34,.1);border:1px solid rgba(210,153,34,.3);border-radius:6px;padding:8px 12px;font-size:12px;color:var(--yellow);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:8px}

/* ================================================================
   DIFF SUMMARY BAR
================================================================ */
.diff-summary{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.chgbar{display:flex;gap:2px;height:8px;border-radius:4px;overflow:hidden;flex-shrink:0}
.add-seg{background:var(--add-text);height:100%}
.del-seg{background:var(--del-text);height:100%}
.neu-seg{background:var(--bg5);height:100%}

/* ================================================================
   COMMITS
================================================================ */
.commit-item{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:9px;cursor:pointer;transition:background .1s}
.commit-item:hover{background:var(--bg3)}
.commit-item.active{background:var(--bg3);border-left:3px solid var(--accent2);padding-left:9px}
.av{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
.ci-info{flex:1;min-width:0}
.ci-sub{font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-meta{font-size:11px;color:var(--text2);margin-top:1px}
.ci-refs{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px}
.ref-chip{font-size:10px;padding:1px 5px;border-radius:8px}
.ref-chip.branch{background:rgba(31,111,235,.2);color:var(--link)}
.ref-chip.head{background:rgba(63,185,80,.2);color:var(--add-text)}
.ref-chip.tag{background:rgba(210,153,34,.2);color:var(--yellow)}
.ci-hash{font-size:11px;background:var(--bg3);padding:2px 6px;border-radius:4px;color:var(--link);border:1px solid var(--border);flex-shrink:0}

/* ================================================================
   STATUS ITEMS
================================================================ */
.status-item{padding:7px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;cursor:pointer;transition:background .1s}
.status-item:hover{background:var(--bg3)}
.st-badge{width:17px;height:17px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;flex-shrink:0}
.st-badge.M{background:rgba(31,111,235,.2);color:var(--link)}
.st-badge.A{background:rgba(63,185,80,.2);color:var(--add-text)}
.st-badge.D{background:rgba(248,81,73,.2);color:var(--del-text)}
.st-badge.R{background:rgba(210,153,34,.2);color:var(--yellow)}
.st-badge.U,.st-badge.Q{background:rgba(139,148,158,.2);color:var(--text3)}
.st-path{flex:1;font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.st-adddel{display:flex;gap:4px;font-size:11px;flex-shrink:0}

/* ================================================================
   FILE TREE
================================================================ */
.tree-row{padding:4px 10px;display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--text2);transition:all .1s;white-space:nowrap}
.tree-row:hover{background:var(--bg3);color:var(--text)}

/* ================================================================
   MISC
================================================================ */
.section-title{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-title .cnt{font-size:11px;color:var(--text2);background:var(--bg3);padding:1px 7px;border-radius:10px;font-weight:500}
.back-btn{display:inline-flex;align-items:center;gap:5px;color:var(--link);cursor:pointer;font-size:13px;margin-bottom:14px}
.back-btn:hover{text-decoration:underline}
.empty{text-align:center;padding:40px 24px;color:var(--text2)}
.empty svg{opacity:.3;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto}
.empty h3{font-size:15px;margin-bottom:6px;color:var(--text)}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;color:var(--text2);gap:12px}
.spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent2);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.notif{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 16px;font-size:13px;color:var(--text);z-index:9999;transform:translateY(20px);opacity:0;transition:all .2s;pointer-events:none;box-shadow:0 4px 20px var(--shadow)}
.notif.show{transform:translateY(0);opacity:1}
.notif.ok{border-color:var(--accent)}
.notif.err{border-color:var(--del-text)}
code{background:var(--bg3);padding:1px 5px;border-radius:3px;font-size:12px}
.mono{font-family:inherit}

.commit-detail-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:14px}
.commit-detail-card .subject{font-size:17px;font-weight:700;margin-bottom:8px;line-height:1.3}
.commit-detail-card .body-text{font-size:12px;color:var(--text2);white-space:pre-wrap;border-left:3px solid var(--border);padding-left:10px;margin:8px 0}
.commit-meta-grid{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
.commit-meta-item{font-size:12px;color:var(--text2)}
.commit-meta-item strong{color:var(--text)}
.parent-link{font-size:11px;color:var(--link);cursor:pointer}
.parent-link:hover{text-decoration:underline}

.tag-row{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.tag-name{font-size:12px;color:var(--yellow)}
.tag-msg{flex:1;font-size:12px;color:var(--text2)}
.stash-row{padding:9px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
.stash-row:hover{background:var(--bg3)}
.stash-ref{font-size:11px;color:var(--link)}
.stash-msg{font-size:13px;color:var(--text)}
.stash-time{font-size:11px;color:var(--text3)}

.contrib-row{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.contrib-info{flex:1;min-width:0}
.contrib-bar{height:4px;background:var(--bg4);border-radius:2px;margin-top:4px;overflow:hidden}
.contrib-bar div{height:100%;background:var(--accent2);border-radius:2px;transition:width .4s}

.compare-form{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.compare-form input{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:13px;min-width:160px;font-family:inherit}
.compare-form input:focus{outline:none;border-color:var(--accent2)}

.activity-chart{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;overflow-x:auto}
.activity-title{font-size:11px;font-weight:700;margin-bottom:10px;color:var(--text);text-transform:uppercase;letter-spacing:.4px}
.heatmap{display:flex;gap:3px}
.hm-col{display:flex;flex-direction:column;gap:3px}
.hm-cell{width:11px;height:11px;border-radius:2px;cursor:default;transition:transform .1s}
.hm-cell:hover{transform:scale(1.4)}
.hm-0{background:var(--bg4)}.hm-1{background:rgba(63,185,80,.3)}.hm-2{background:rgba(63,185,80,.55)}.hm-3{background:rgba(63,185,80,.75)}.hm-4{background:var(--add-text)}

.blame-table{width:100%;border-collapse:collapse;font-size:12px}
.bl-hash{width:60px;padding:1px 8px;color:var(--link);cursor:pointer;white-space:nowrap;user-select:none}
.bl-hash:hover{text-decoration:underline}
.bl-author{width:110px;padding:1px 6px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bl-date{width:85px;padding:1px 6px;color:var(--text3);white-space:nowrap}
.bl-ln{width:40px;text-align:right;padding:1px 6px;color:var(--text3);user-select:none}
.bl-code{padding:1px 8px;white-space:pre;color:var(--text)}
.blame-table tr:hover td{background:var(--bg3)}
.blame-table tr td{border-bottom:1px solid var(--border2)}

.lang-bar{display:flex;height:8px;border-radius:4px;overflow:hidden;margin-bottom:10px}
.lang-legend{display:flex;flex-wrap:wrap;gap:8px 14px}
.lang-item{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text2)}
.lang-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}

.vs-sentinel{height:1px;visibility:hidden}

/* ================================================================
   MOBILE
================================================================ */
@media(max-width:700px){
  .sidebar{position:absolute;z-index:150;height:calc(100% - 50px);top:50px;left:0;transform:translateX(-100%);transition:transform .25s ease;width:280px !important}
  .sidebar.mobile-open{transform:translateX(0)}
  .sidebar.collapsed{transform:translateX(-100%)}
  .sb-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:140;display:none}
  .sb-backdrop.show{display:block}
  .topbar-pill,.topbar-branch{display:none}
  .topbar{padding:0 10px;gap:7px}
  .theme-toggle .theme-opt{padding:3px 7px}
  .main{padding:10px 10px}
  .stats-grid{grid-template-columns:1fr 1fr;gap:6px}
  .stat-card .val{font-size:18px}
  /* On mobile, copy btn only shows on long press - hide by default */
  .clb{display:none}
  /* Fix: on mobile the file path can wrap so you can read it */
  .diff-file-hdr .fpath{white-space:normal;overflow:visible;text-overflow:unset;font-size:11px;word-break:break-all;line-height:1.4}
  .diff-toolbar{gap:4px}
  /* Mobile nav bar */
  .mnav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);z-index:200;height:54px}
  .mn-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:9px;font-weight:700;color:var(--text3);cursor:pointer;text-transform:uppercase;letter-spacing:.3px;border:none;background:none;font-family:inherit;transition:color .1s}
  .mn-btn.active{color:var(--add-text)}
  .body{padding-bottom:54px}
  .notif{bottom:70px;right:10px;left:10px;text-align:center}
}
@media(min-width:701px){
  .mnav{display:none}
  .sb-backdrop{display:none !important}
}
</style>
</head>
<body>
<div class="app">

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand" onclick="showOverview()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <circle cx="12" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/>
      <line x1="6" y1="9" x2="6" y2="15"/><path d="M18 9c0 3.866-2.686 7-6 9"/>
    </svg>
    git-diff
  </div>
  <div class="topbar-pill" id="topbarRepo">Loading‚Ä¶</div>
  <div class="topbar-branch" id="topbarBranch">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/><line x1="6" y1="9" x2="6" y2="15"/><path d="M18 9c0 3.866-2.686 7-6 9"/></svg>
    <span id="branchName">‚Äî</span>
  </div>
  <div class="topbar-right">
    <div class="theme-toggle" title="Switch theme">
      <button class="theme-opt" onclick="setTheme('light')" id="t-light">‚òÄÔ∏è</button>
      <button class="theme-opt active" onclick="setTheme('dark')" id="t-dark">üåô</button>
      <button class="theme-opt" onclick="setTheme('amoled')" id="t-amoled">‚ö´</button>
    </div>
    <button class="btn" onclick="showCompare()" title="Ctrl+K">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Compare
    </button>
    <button class="btn" onclick="refreshData()" title="Ctrl+R">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      Refresh
    </button>
    <button class="btn icon" onclick="toggleSidebar()" title="Toggle sidebar (Ctrl+\)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
    </button>
  </div>
</div>

<!-- BODY -->
<div class="body">
  <div class="sidebar" id="sidebar">
    <div class="snav">
      <div class="snav-tab active" onclick="switchNav('changes')" id="sn-changes">Changes</div>
      <div class="snav-tab" onclick="switchNav('commits')" id="sn-commits">Commits</div>
      <div class="snav-tab" onclick="switchNav('files')" id="sn-files">Files</div>
      <div class="snav-tab" onclick="switchNav('info')" id="sn-info">Info</div>
    </div>
    <div class="sidebar-body" id="sidebarBody">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="sb-backdrop" id="sbBackdrop" onclick="closeMobileSidebar()"></div>

  <div class="main" id="main">
    <div class="loading"><div class="spinner"></div><div>Loading repository‚Ä¶</div></div>
  </div>
</div>

<!-- MOBILE NAV BAR -->
<div class="mnav">
  <button class="mn-btn active" id="mn-overview" onclick="showOverview();setMN('overview')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    Overview
  </button>
  <button class="mn-btn" id="mn-changes" onclick="switchNav('changes');openMobileSidebar();setMN('changes')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
    Changes
  </button>
  <button class="mn-btn" id="mn-commits" onclick="switchNav('commits');openMobileSidebar();setMN('commits')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg>
    Commits
  </button>
  <button class="mn-btn" id="mn-files" onclick="switchNav('files');openMobileSidebar();setMN('files')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
    Files
  </button>
  <button class="mn-btn" id="mn-compare" onclick="showCompare();setMN('compare')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    Compare
  </button>
</div>

</div>
<div class="notif" id="notif"></div>

<script>
'use strict';

// ================================================================
// STATE
// ================================================================
let DATA = null;
let sidebarVisible = true;
let currentNav = 'changes';
let commitCache = {};
let currentTheme = localStorage.getItem('gd-theme') || 'dark';
let diffFontSize = parseInt(localStorage.getItem('gd-fs') || '12', 10);
let wrapMode = localStorage.getItem('gd-wrap') === '1';
const CHUNK = 200; // lines per progressive render
const fileDataMap = {}; // stores flattened lines for large files

// ================================================================
// BOOT
// ================================================================
(async () => {
  applyTheme(currentTheme);
  try {
    const r = await fetch('/api/data');
    DATA = await r.json();
    hydrate();
    showOverview();
  } catch(e) {
    setMain(`<div class="empty"><h3>Failed to connect</h3><p>${e.message}</p></div>`);
  }
})();

function hydrate() {
  const rp = DATA.repo;
  document.title = `git-diff ‚Äî ${rp.name}`;
  _id('topbarRepo').textContent = rp.name;
  _id('branchName').textContent = rp.current_branch;
  switchNav(currentNav);
}

// ================================================================
// THEME
// ================================================================
function applyTheme(t) {
  currentTheme = t;
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('gd-theme', t);
  ['dark','light','amoled'].forEach(x => _id('t-'+x)?.classList.toggle('active', x === t));
}
function setTheme(t) { applyTheme(t); }

// ================================================================
// FONT SIZE / ZOOM
// ================================================================
function applyFontSize(sz) {
  diffFontSize = Math.min(24, Math.max(8, sz));
  localStorage.setItem('gd-fs', diffFontSize);
  document.querySelectorAll('.dtw').forEach(el => el.style.fontSize = diffFontSize + 'px');
  document.querySelectorAll('.fs-ind').forEach(el => el.textContent = diffFontSize + 'px');
}
function zoomIn() { applyFontSize(diffFontSize + 1); }
function zoomOut() { applyFontSize(diffFontSize - 1); }
function zoomReset() { applyFontSize(12); }

// ================================================================
// WRAP MODE
// ================================================================
function toggleWrap() {
  wrapMode = !wrapMode;
  localStorage.setItem('gd-wrap', wrapMode ? '1' : '0');
  document.querySelectorAll('.diff-body').forEach(b => b.classList.toggle('wrap-mode', wrapMode));
  document.querySelectorAll('.wrap-btn').forEach(b => b.classList.toggle('active-btn', wrapMode));
}

// ================================================================
// SIDEBAR NAV
// ================================================================
function switchNav(tab) {
  currentNav = tab;
  ['changes','commits','files','info'].forEach(t => _id('sn-'+t)?.classList.toggle('active', t === tab));
  if (!DATA) return;
  const el = _id('sidebarBody');
  if (tab === 'changes') el.innerHTML = buildChangesNav();
  else if (tab === 'commits') el.innerHTML = buildCommitsNav();
  else if (tab === 'files') el.innerHTML = buildFilesNav();
  else if (tab === 'info') el.innerHTML = buildInfoNav();
}

function toggleSidebar() {
  const sb = _id('sidebar');
  if (window.innerWidth <= 700) {
    sb.classList.toggle('mobile-open');
    _id('sbBackdrop').classList.toggle('show', sb.classList.contains('mobile-open'));
    sidebarVisible = sb.classList.contains('mobile-open');
  } else {
    sidebarVisible = !sidebarVisible;
    sb.classList.toggle('collapsed', !sidebarVisible);
  }
}
function openMobileSidebar() {
  _id('sidebar').classList.remove('collapsed');
  _id('sidebar').classList.add('mobile-open');
  _id('sbBackdrop').classList.add('show');
  sidebarVisible = true;
}
function closeMobileSidebar() {
  _id('sidebar').classList.remove('mobile-open');
  _id('sbBackdrop').classList.remove('show');
  sidebarVisible = false;
}
function setMN(id) {
  document.querySelectorAll('.mn-btn').forEach(b => b.classList.remove('active'));
  _id('mn-' + id)?.classList.add('active');
}

// ‚îÄ‚îÄ Changes nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildChangesNav() {
  const s = DATA.staged_diff, u = DATA.unstaged_diff, st = DATA.status;
  let h = `<div class="search-bar"><input class="search-input" placeholder="Filter files‚Ä¶" oninput="filterSidebarFiles(this)"></div>`;
  if (st.length === 0) return h + `<div class="empty" style="padding:30px 16px">‚ú® Working tree clean</div>`;
  if (s.files.length) h += sidebarSection(`Staged (${s.files.length})`, s.files.map(f => sidebarFileRow(f, `showStagedFile('${ea(f.new_path)}')`)).join(''));
  if (u.files.length) h += sidebarSection(`Unstaged (${u.files.length})`, u.files.map(f => sidebarFileRow(f, `showUnstagedFile('${ea(f.new_path)}')`)).join(''));
  return h;
}
function filterSidebarFiles(inp) {
  const q = inp.value.toLowerCase();
  inp.closest('.sidebar-body')?.querySelectorAll('.status-item').forEach(el => {
    el.style.display = !q || el.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}
function sidebarSection(title, content) {
  return `<div style="padding:5px 10px;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)">${E(title)}</div>${content}`;
}
function sidebarFileRow(f, onclick) {
  const s = f.is_new ? 'A' : f.is_deleted ? 'D' : f.status === 'renamed' ? 'R' : 'M';
  const path = f.new_path || f.old_path;
  return `<div class="status-item" onclick="${onclick};closeMobileSidebar()">
    <span class="st-badge ${s}">${s}</span>
    <span class="st-path" title="${E(path)}">${E(path)}</span>
    <span class="st-adddel">
      <span style="color:var(--add-text)">+${f.additions}</span>
      <span style="color:var(--del-text)">-${f.deletions}</span>
    </span>
  </div>`;
}

// ‚îÄ‚îÄ Commits nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildCommitsNav() {
  let h = `<div class="search-bar"><input class="search-input" placeholder="Search commits‚Ä¶" oninput="filterCommitsNav(this)"></div>`;
  h += DATA.commits.slice(0, 300).map(c => commitRow(c)).join('');
  if (DATA.commits.length >= 300) h += `<div style="padding:8px;text-align:center"><button class="btn sm" onclick="loadMoreCommits()">Load more</button></div>`;
  return h;
}
function filterCommitsNav(inp) {
  const q = inp.value.toLowerCase();
  inp.closest('.sidebar-body')?.querySelectorAll('.commit-item').forEach(el => {
    el.style.display = !q || el.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}
async function loadMoreCommits() {
  const offset = DATA.commits.length;
  try {
    const r = await fetch(`/api/commits?limit=200&offset=${offset}`);
    const d = await r.json();
    DATA.commits.push(...d.commits);
    switchNav('commits');
  } catch(e) { notify('Failed to load more', 'err'); }
}
function commitRow(c) {
  const refs = renderRefs(c.refs);
  return `<div class="commit-item" id="cr-${c.hash}" onclick="showCommit('${c.hash}');closeMobileSidebar()">
    <div class="av" style="background:${avatarColor(c.author_name)}">${avatarInit(c.author_name)}</div>
    <div class="ci-info">
      <div class="ci-sub" title="${E(c.subject)}">${E(c.subject)}</div>
      <div class="ci-meta">${E(c.author_name)} ¬∑ ${E(c.date_relative)}</div>
      ${refs ? `<div class="ci-refs">${refs}</div>` : ''}
    </div>
    <div class="ci-hash">${c.short_hash}</div>
  </div>`;
}
function renderRefs(refs) {
  if (!refs) return '';
  return refs.split(',').filter(r=>r.trim()).map(r => {
    const rv = r.trim();
    const cls = rv.startsWith('HEAD ->') ? 'head' : rv.startsWith('tag:') ? 'tag' : 'branch';
    return `<span class="ref-chip ${cls}">${E(rv.replace('tag: ',''))}</span>`;
  }).join('');
}

// ‚îÄ‚îÄ Files nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildFilesNav() {
  let h = `<div class="search-bar"><input class="search-input" placeholder="Filter files‚Ä¶" oninput="filterFilesNav(this)"></div>`;
  h += `<div id="snFileList">` + DATA.file_tree.slice(0, 2000).map(f =>
    `<div class="tree-row" onclick="showFileView('${ea(f.path)}');closeMobileSidebar()" title="${E(f.path)}">
      ${fileIcon(f.path)}
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis">${E(f.path)}</span>
    </div>`).join('') + `</div>`;
  if (DATA.file_tree.length > 2000) h += `<div style="padding:8px 10px;font-size:11px;color:var(--text3)">Showing 2000 of ${DATA.file_tree.length} files</div>`;
  return h;
}
function filterFilesNav(inp) {
  const q = inp.value.toLowerCase();
  _id('snFileList')?.querySelectorAll('.tree-row').forEach(el => {
    el.style.display = !q || el.title.toLowerCase().includes(q) ? '' : 'none';
  });
}
function fileIcon(path) {
  const ext = path.split('.').pop().toLowerCase();
  const c = {py:'#3572a5',js:'#f1e05a',ts:'#2b7489',jsx:'#61dafb',tsx:'#61dafb',html:'#e34c26',css:'#563d7c',scss:'#c6538c',json:'#cbcb41',md:'#083fa1',yml:'#cb171e',yaml:'#cb171e',sh:'#89e051',go:'#00add8',rs:'#dea584',java:'#b07219',rb:'#701516',php:'#4f5d95',c:'#555',cpp:'#f34b7d',cs:'#178600'};
  return `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="${c[ext]||'#8b949e'}" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`;
}

// ‚îÄ‚îÄ Info nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildInfoNav() {
  const r = DATA.repo;
  const row = (lbl, val) => `<div style="display:flex;gap:8px;margin-bottom:6px;align-items:flex-start"><span style="font-size:11px;color:var(--text2);width:68px;flex-shrink:0;padding-top:1px">${lbl}</span><span style="font-size:12px;flex:1;word-break:break-all">${val}</span></div>`;
  let h = `<div style="padding:12px">`;
  h += row('Name', E(r.name));
  h += row('Path', E(r.path));
  if (r.remote_url) h += row('Remote', `<a href="${E(r.remote_url)}" target="_blank" style="font-size:11px">${E(r.remote_url)}</a>`);
  h += row('Branch', `<code>${E(r.current_branch)}</code>`);
  h += row('HEAD', `<code>${E(r.head_short)}</code>`);
  h += row('Commits', r.total_commits.toLocaleString());
  h += row('Files', DATA.file_tree.length.toLocaleString());
  h += row('Authors', r.contributors.length);
  h += row('Size', r.size);
  h += row('Git size', r.git_size);
  h += row('Since', r.first_commit_date);
  h += `</div>`;
  if (DATA.stashes.length) {
    h += sidebarSection(`Stashes (${DATA.stashes.length})`, DATA.stashes.map(s =>
      `<div class="stash-row" onclick="showStash('${ea(s.ref)}')">
        <div class="stash-ref">${E(s.ref)}</div>
        <div class="stash-msg">${E(s.message)}</div>
        <div class="stash-time">${E(s.relative)}</div>
      </div>`).join(''));
  }
  if (DATA.repo.tags.length) {
    h += sidebarSection(`Tags (${DATA.repo.tags.length})`, DATA.repo.tags.map(t =>
      `<div class="tag-row"><span class="tag-name">${E(t.name)}</span><span class="tag-msg">${E(t.message)}</span><span style="font-size:11px;color:var(--text3)">${E(t.date)}</span></div>`).join(''));
  }
  return h;
}

// ================================================================
// OVERVIEW
// ================================================================
function showOverview() {
  if (!DATA) return;
  const r = DATA.repo, s = DATA.staged_diff, u = DATA.unstaged_diff, st = DATA.status;
  let html = `<div style="margin-bottom:16px">
    <div style="font-size:22px;font-weight:800;margin-bottom:2px">${E(r.name)}</div>
    ${r.remote_url ? `<a href="${E(r.remote_url)}" target="_blank" style="font-size:12px;color:var(--text2)">${E(r.remote_url)}</a>` : ''}
  </div>`;
  html += `<div class="stats-grid">
    ${statCard(r.total_commits.toLocaleString(),'Commits','var(--add-text)',`showCommit('${r.head_short}')`)}
    ${statCard(r.current_branch,'Branch','var(--link)','')}
    ${statCard(r.branch_count,'Branches','var(--yellow)',"showTab('branches')")}
    ${statCard(r.tags.length,'Tags','var(--accent3)',"showTab('branches')")}
    ${statCard(r.contributors.length,'Contributors','var(--orange)',"showTab('contributors')")}
    ${statCard(DATA.file_tree.length.toLocaleString(),'Files','var(--text2)',"switchNav('files')")}
    ${statCard(`+${s.total_additions}`,'Staged +','var(--add-text)',"showTab('changes')")}
    ${statCard(`-${u.total_deletions}`,'Unstaged ‚àí','var(--del-text)',"showTab('changes')")}
  </div>`;
  html += buildHeatmap();
  html += `<div class="ctabs">
    <div class="ctab active" onclick="showTab('changes')" id="ct-changes">Changes <span class="badge">${st.length}</span></div>
    <div class="ctab" onclick="showTab('history')" id="ct-history">History <span class="badge">${DATA.commits.length}</span></div>
    <div class="ctab" onclick="showTab('contributors')" id="ct-contributors">Contributors <span class="badge">${r.contributors.length}</span></div>
    <div class="ctab" onclick="showTab('branches')" id="ct-branches">Branches <span class="badge">${r.branches.length}</span></div>
    <div class="ctab" onclick="showTab('langs')" id="ct-langs">Languages</div>
  </div>`;
  html += buildChangesPane(s, u, st);
  html += buildHistoryPane();
  html += buildContributorsPane(r.contributors);
  html += buildBranchesPane(r);
  html += buildLangsPane();
  setMain(html);
}
function showTab(name) {
  document.querySelectorAll('.tab-pane').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.ctab').forEach(e=>e.classList.remove('active'));
  _id('tab-'+name)?.classList.add('active');
  _id('ct-'+name)?.classList.add('active');
}
function statCard(val, lbl, color, onclick) {
  return `<div class="stat-card" ${onclick?`onclick="${onclick}"`:''}>
    <div class="lbl">${lbl}</div>
    <div class="val" style="color:${color}">${E(String(val))}</div>
  </div>`;
}
function buildHeatmap() {
  const stats = DATA.commit_stats || {};
  if (!Object.keys(stats).length) return '';
  const today = new Date(); today.setHours(0,0,0,0);
  const cells = [];
  for (let w=12;w>=0;w--){const col=[];for(let d=6;d>=0;d--){const dt=new Date(today);dt.setDate(today.getDate()-w*7-d);const key=dt.toISOString().slice(0,10);col.push({date:key,count:stats[key]||0});}cells.push(col);}
  const max = Math.max(...Object.values(stats),1);
  let h = `<div class="activity-chart"><div class="activity-title">Commit activity ‚Äî last 90 days</div><div class="heatmap">`;
  cells.forEach(col=>{h+=`<div class="hm-col">`;col.forEach(cell=>{const lvl=cell.count===0?0:cell.count<max*.25?1:cell.count<max*.5?2:cell.count<max*.75?3:4;h+=`<div class="hm-cell hm-${lvl}" title="${cell.date}: ${cell.count} commits"></div>`;});h+=`</div>`;});
  return h+`</div></div>`;
}
function buildChangesPane(s, u, st) {
  let h = `<div class="tab-pane active" id="tab-changes">`;
  if (!s.total_files && !u.total_files) {
    h += `<div class="empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><h3>Working tree clean</h3></div>`;
  } else {
    if (s.total_files) { h += `<div class="section-title">Staged Changes <span class="cnt">${s.total_files} files</span></div>${diffSummaryBar(s)}${diffToolbar()}${renderDiffFiles(s.files,'ov-staged')}`; }
    if (u.total_files) { h += `<div class="section-title" style="margin-top:20px">Unstaged Changes <span class="cnt">${u.total_files} files</span></div>${diffSummaryBar(u)}${s.total_files?'':diffToolbar()}${renderDiffFiles(u.files,'ov-unstaged')}`; }
  }
  return h + `</div>`;
}
function buildHistoryPane() {
  let h = `<div class="tab-pane" id="tab-history">`;
  h += DATA.commits.slice(0,100).map(c=>commitRow(c)).join('');
  if (DATA.commits.length>100) h += `<div style="padding:10px;text-align:center;color:var(--text2);font-size:12px">Showing 100 of ${DATA.commits.length}. Use sidebar for more.</div>`;
  return h + `</div>`;
}
function buildContributorsPane(contribs) {
  const max = contribs[0]?.commits || 1;
  let h = `<div class="tab-pane" id="tab-contributors">`;
  h += contribs.map(c => {
    const pct = Math.round((c.commits/max)*100);
    return `<div class="contrib-row">
      <div class="av" style="background:${avatarColor(c.name)};width:32px;height:32px;font-size:12px">${avatarInit(c.name)}</div>
      <div class="contrib-info">
        <div style="font-size:13px;font-weight:600">${E(c.name)}</div>
        <div style="font-size:11px;color:var(--text2)">${E(c.email)}</div>
        <div class="contrib-bar" style="width:180px;max-width:100%"><div style="width:${pct}%"></div></div>
      </div>
      <div style="font-size:12px;color:var(--text2)">${c.commits.toLocaleString()}</div>
    </div>`;
  }).join('');
  return h + `</div>`;
}
function buildBranchesPane(r) {
  const local = r.branches.filter(b=>!b.is_remote), remote = r.branches.filter(b=>b.is_remote);
  let h = `<div class="tab-pane" id="tab-branches">`;
  if (r.tags.length) {
    h += `<div class="section-title">Tags <span class="cnt">${r.tags.length}</span></div>`;
    h += r.tags.map(t => `<div class="tag-row"><span class="tag-name" style="width:120px">${E(t.name)}</span><span class="tag-msg">${E(t.message)}</span><code style="font-size:11px">${E(t.hash)}</code><span style="font-size:11px;color:var(--text3)">${E(t.date)}</span></div>`).join('');
    h += `<div style="margin-top:16px"></div>`;
  }
  h += `<div class="section-title">Local Branches <span class="cnt">${local.length}</span></div>`;
  h += local.map(b => `<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
    <span style="font-size:13px;color:${b.is_current?'var(--add-text)':'var(--text)'}">${E(b.name)}</span>
    ${b.is_current ? '<span class="pill add">current</span>' : `<button class="btn sm" onclick="showCompareWith('${ea(r.current_branch)}','${ea(b.name)}')">Diff</button>`}
    <span style="margin-left:auto;font-size:11px;color:var(--text3)">${E(b.date)}</span>
  </div>`).join('');
  if (remote.length) {
    h += `<div class="section-title" style="margin-top:16px">Remote Branches <span class="cnt">${remote.length}</span></div>`;
    h += remote.map(b => `<div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
      <span style="font-size:12px;color:var(--text2)">${E(b.name)}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text3)">${E(b.date)}</span>
    </div>`).join('');
  }
  return h + `</div>`;
}
function buildLangsPane() {
  const langs = DATA.lang_stats || [];
  const COLS = ['#3572a5','#f1e05a','#2b7489','#e34c26','#563d7c','#cbcb41','#89e051','#dea584','#b07219','#701516','#f34b7d','#178600','#00add8','#c6538c','#383838'];
  let h = `<div class="tab-pane" id="tab-langs"><div class="lang-bar">`;
  langs.slice(0,15).forEach((l,i) => { h += `<div style="flex:${l.count};background:${COLS[i%COLS.length]}" title="${l.ext}: ${l.pct}%"></div>`; });
  h += `</div><div class="lang-legend">`;
  langs.slice(0,20).forEach((l,i) => { h += `<div class="lang-item"><div class="lang-dot" style="background:${COLS[i%COLS.length]}"></div><span>${E(l.ext)}</span><span style="color:var(--text3)">${l.pct}%</span><span style="color:var(--text3)">(${l.count})</span></div>`; });
  return h + `</div></div>`;
}

// ================================================================
// DIFF TOOLBAR
// ================================================================
function diffToolbar() {
  return `<div class="diff-toolbar">
    <div class="toolbar-group">
      <button class="btn" onclick="zoomOut()" title="Zoom out (Ctrl+-)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
      </button>
      <span class="fs-ind fs-indicator">${diffFontSize}px</span>
      <button class="btn" onclick="zoomIn()" title="Zoom in (Ctrl++)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
      </button>
    </div>
    <button class="btn wrap-btn ${wrapMode?'active-btn':''}" onclick="toggleWrap()" title="Toggle line wrap">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
      Wrap
    </button>
    <button class="btn" onclick="collapseAll()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
      Collapse all
    </button>
    <button class="btn" onclick="expandAll()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
      Expand all
    </button>
  </div>`;
}
function collapseAll() {
  document.querySelectorAll('.diff-body').forEach(b => {
    b.style.display = 'none';
    const id = b.id?.replace('-body','');
    const arr = _id(id+'-arr'); if (arr) arr.style.transform = 'rotate(-90deg)';
  });
}
function expandAll() {
  document.querySelectorAll('.diff-body').forEach(b => {
    b.style.display = '';
    const id = b.id?.replace('-body','');
    const arr = _id(id+'-arr'); if (arr) arr.style.transform = '';
  });
  setTimeout(observeSentinels, 0);
}

// ================================================================
// DIFF RENDERING + PROGRESSIVE LOADING
// ================================================================
function diffSummaryBar(diff) {
  const tot = diff.total_additions + diff.total_deletions || 1;
  const aS = Math.round((diff.total_additions/tot)*5), dS = Math.round((diff.total_deletions/tot)*5), nS = Math.max(0,5-aS-dS);
  return `<div class="diff-summary">
    <b>${diff.total_files} files changed</b>
    <div class="chgbar">
      ${Array(aS).fill(`<div class="add-seg" style="flex:1"></div>`).join('')}
      ${Array(dS).fill(`<div class="del-seg" style="flex:1"></div>`).join('')}
      ${Array(nS).fill(`<div class="neu-seg" style="flex:1"></div>`).join('')}
    </div>
    <span style="color:var(--add-text)">+${diff.total_additions}</span>
    <span style="color:var(--del-text)">-${diff.total_deletions}</span>
  </div>`;
}

function renderDiffFiles(files, prefix) {
  return files.map((f, i) => renderDiffFile(f, `${prefix}-${i}`)).join('');
}

function countLines(f) {
  return (f.hunks||[]).reduce((a,h)=>a+h.lines.length,0);
}

function renderDiffFile(f, id) {
  const s = f.is_new?'A':f.is_deleted?'D':f.status==='renamed'?'R':f.status==='copied'?'C':'M';
  const dispPath = f.status==='renamed' ? `${f.old_path} ‚Üí ${f.new_path}` : (f.new_path||f.old_path);
  const simBadge = (f.similarity!=null && f.status==='renamed') ? `<span class="pill na">${f.similarity}% similar</span>` : '';
  const lineCount = countLines(f);
  const isLarge = lineCount > 500;

  return `<div class="diff-file">
    <div class="diff-file-hdr" onclick="toggleFile('${id}')">
      <span class="fstatus ${s}">${s}</span>
      <span class="fpath" title="${E(dispPath)}">${E(dispPath)}</span>
      <span class="fstats">
        ${simBadge}
        ${f.is_binary ? `<span class="pill na">Binary</span>` : `<span class="pill add">+${f.additions}</span><span class="pill del">-${f.deletions}</span>`}
        ${lineCount > 0 ? `<span class="pill na" style="display:none" id="${id}-lc">${lineCount} lines</span>` : ''}
        <button class="btn sm" onclick="event.stopPropagation();copyFileChanges('${id}')" title="Copy changed lines" style="font-size:10px;padding:2px 6px;opacity:.7">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          Copy
        </button>
      </span>
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="${id}-arr" style="flex-shrink:0;transition:transform .15s"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div id="${id}-body" class="diff-body ${wrapMode?'wrap-mode':''}">
      ${isLarge ? `<div class="lf-notice" id="${id}-lfn">
        <span>‚ö° Large file ‚Äî ${lineCount} lines, loading progressively</span>
        <button class="btn sm" onclick="loadAll('${id}')">Load all</button>
      </div>` : ''}
      <div class="diff-inner dtw" id="${id}-inner" style="font-size:${diffFontSize}px">
        ${buildFileContent(f, id, isLarge)}
      </div>
    </div>
  </div>`;
}

function flattenFile(f) {
  const segs = [];
  (f.hunks||[]).forEach(hunk => {
    segs.push({t:'h', hunk});
    let o=hunk.old_start, n=hunk.new_start;
    hunk.lines.forEach(l => {
      let oN='', nN='';
      if(l.type==='del'){oN=o++;}else if(l.type==='add'){nN=n++;}else{oN=o++;nN=n++;}
      segs.push({t:'l', l, oN, nN});
    });
  });
  return segs;
}

function buildFileContent(f, id, isLarge) {
  if (f.is_binary) return `<div class="binary-msg">‚äò Binary file ‚Äî diff not available</div>`;
  if (!f.hunks?.length) return `<div class="binary-msg">No textual changes</div>`;

  const segs = flattenFile(f);
  if (isLarge) {
    fileDataMap[id] = {segs, rendered: 0};
    return renderSegs(segs, 0, CHUNK) + sentinel(id);
  }
  return renderSegs(segs, 0, segs.length);
}

function renderSegs(segs, from, to) {
  let h = '';
  const end = Math.min(to, segs.length);
  for (let i=from; i<end; i++) {
    const seg = segs[i];
    if (seg.t === 'h') {
      h += `<div class="hunk-header"><span class="range">@@ -${seg.hunk.old_start},${seg.hunk.old_count} +${seg.hunk.new_start},${seg.hunk.new_count} @@</span><span class="ctx"> ${E(seg.hunk.context)}</span></div>`;
    } else {
      const {l,oN,nN} = seg;
      const sign = l.type==='add'?'+':l.type==='del'?'-':' ';
      const content = JSON.stringify(l.content);
      h += `<div class="dl ${l.type}">
        <div class="ln">${oN}</div>
        <div class="ln">${nN}</div>
        <div class="lc"><span class="sign">${sign}</span>${EH(l.content)}</div>
        <button class="clb" onclick="copyText(${content})" title="Copy line">‚éò</button>
      </div>`;
    }
  }
  return h;
}

function sentinel(id) {
  return `<div class="vs-sentinel" id="${id}-sent" data-fid="${id}"></div>
    <div id="${id}-more" style="text-align:center;padding:10px">
      <button class="btn sm" onclick="loadNextChunk('${id}')">Load more lines ‚Üì</button>
    </div>`;
}

function loadNextChunk(id) {
  const state = fileDataMap[id];
  if (!state) return;
  _id(id+'-sent')?.remove();
  _id(id+'-more')?.remove();
  const inner = _id(id+'-inner');
  if (!inner) return;
  const from = state.rendered;
  const to = from + CHUNK;
  const frag = document.createElement('template');
  frag.innerHTML = renderSegs(state.segs, from, to);
  inner.appendChild(frag.content);
  state.rendered = to;
  if (to < state.segs.length) {
    const s2 = document.createElement('template');
    s2.innerHTML = sentinel(id);
    inner.appendChild(s2.content);
    setTimeout(observeSentinels, 0);
  }
}

function loadAll(id) {
  const state = fileDataMap[id];
  if (!state) return;
  _id(id+'-sent')?.remove();
  _id(id+'-more')?.remove();
  _id(id+'-lfn')?.remove();
  const inner = _id(id+'-inner');
  if (!inner) return;
  const frag = document.createElement('template');
  frag.innerHTML = renderSegs(state.segs, state.rendered, state.segs.length);
  inner.appendChild(frag.content);
  state.rendered = state.segs.length;
}

// IntersectionObserver for auto-progressive loading
const io = new IntersectionObserver(entries => {
  entries.forEach(e => { if (e.isIntersecting) loadNextChunk(e.target.dataset.fid); });
}, {rootMargin:'300px'});

function observeSentinels() {
  document.querySelectorAll('.vs-sentinel:not([data-observed])').forEach(el => {
    el.dataset.observed = '1';
    io.observe(el);
  });
}

function toggleFile(id) {
  const body = _id(id+'-body'), arr = _id(id+'-arr');
  if (!body) return;
  const hidden = body.style.display === 'none';
  body.style.display = hidden ? '' : 'none';
  if (arr) arr.style.transform = hidden ? '' : 'rotate(-90deg)';
  if (hidden) setTimeout(observeSentinels, 0);
}

function copyFileChanges(id) {
  const inner = _id(id+'-inner');
  if (!inner) return;
  const lines = [];
  inner.querySelectorAll('.dl').forEach(row => {
    const lc = row.querySelector('.lc');
    if (!lc) return;
    const sign = lc.querySelector('.sign')?.textContent || '';
    const text = lc.textContent.replace(sign, '');
    if (row.classList.contains('add')) lines.push('+' + text);
    else if (row.classList.contains('del')) lines.push('-' + text);
  });
  copyText(lines.join('\n'));
}

// ================================================================
// COMMIT VIEW
// ================================================================
async function showCommit(hash) {
  document.querySelectorAll('.commit-item').forEach(e=>e.classList.remove('active'));
  _id('cr-'+hash)?.classList.add('active');
  switchNav('commits');
  setMain(loadingHtml('Loading commit diff‚Ä¶'));
  try {
    if (!commitCache[hash]) {
      const r = await fetch(`/api/commit?hash=${hash}`);
      commitCache[hash] = await r.json();
    }
    const {diff, detail} = commitCache[hash];
    renderCommitView(diff, detail);
  } catch(e) {
    setMain(`<div class="empty"><h3>Failed to load diff</h3><p>${e.message}</p></div>`);
  }
}
function renderCommitView(diff, d) {
  let h = backBtn('showOverview()');
  h += `<div class="commit-detail-card">
    <div class="subject">${E(d.subject)}</div>
    ${d.body ? `<div class="body-text">${E(d.body)}</div>` : ''}
    <div class="commit-meta-grid">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="av" style="background:${avatarColor(d.author_name)};width:26px;height:26px;font-size:11px">${avatarInit(d.author_name)}</div>
        <div>
          <div style="font-size:12px;font-weight:600">${E(d.author_name)}</div>
          <div style="font-size:11px;color:var(--text2)">${E(d.author_email)}</div>
        </div>
      </div>
      <div class="commit-meta-item"><strong>Date</strong><br>${E(d.date)} (${E(d.date_relative)})</div>
      <div class="commit-meta-item"><strong>SHA</strong><br><code>${E(d.hash)}</code></div>
      ${d.parents.length ? `<div class="commit-meta-item"><strong>Parent${d.parents.length>1?'s':''}</strong><br>${d.parents.map(p=>`<span class="parent-link" onclick="showCommit('${p}')">${p.slice(0,7)}</span>`).join(', ')}</div>` : ''}
      ${d.is_merge ? `<div class="commit-meta-item"><strong>Type</strong><br><span style="color:var(--accent3)">Merge commit</span></div>` : ''}
    </div>
  </div>`;
  h += `<div class="section-title">Files Changed <span class="cnt">${diff.total_files}</span></div>`;
  if (diff.total_files) { h += diffSummaryBar(diff) + diffToolbar() + renderDiffFiles(diff.files,'commit'); }
  else { h += `<div class="empty">No file changes</div>`; }
  setMain(h);
  setTimeout(observeSentinels, 0);
}

// ================================================================
// STAGED / UNSTAGED FILE
// ================================================================
function showStagedFile(path) {
  const file = DATA.staged_diff.files.find(f=>f.new_path===path||f.old_path===path);
  if (!file) return showOverview();
  setMain(backBtn('showOverview()') + `<div class="section-title">Staged ‚Äî ${E(path)}</div>` + diffToolbar() + renderDiffFiles([file],'sf'));
  setTimeout(observeSentinels, 0);
}
function showUnstagedFile(path) {
  const file = DATA.unstaged_diff.files.find(f=>f.new_path===path||f.old_path===path);
  if (!file) return showOverview();
  setMain(backBtn('showOverview()') + `<div class="section-title">Unstaged ‚Äî ${E(path)}</div>` + diffToolbar() + renderDiffFiles([file],'uf'));
  setTimeout(observeSentinels, 0);
}

// ================================================================
// FILE VIEW
// ================================================================
async function showFileView(path) {
  setMain(loadingHtml(`Loading ${path}‚Ä¶`));
  try {
    const [fc, fl] = await Promise.all([
      fetch(`/api/file?path=${encodeURIComponent(path)}`).then(r=>r.json()),
      fetch(`/api/file-log?path=${encodeURIComponent(path)}&limit=50`).then(r=>r.json()),
    ]);
    const lines = fc.content.split('\n');
    const isLarge = lines.length > 500;
    let h = backBtn('showOverview()');
    h += `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;margin-bottom:10px;display:flex;align-items:center;gap:8px">
      ${fileIcon(path)}<span style="font-size:13px;font-weight:500">${E(path)}</span>
      <span style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <span style="font-size:11px;color:var(--text2)">${lines.length} lines</span>
        <button class="btn sm" onclick="showBlame('${ea(path)}')">Blame</button>
        <button class="btn sm" onclick="copyText(${JSON.stringify(fc.content)})">Copy all</button>
      </span>
    </div>
    <div class="ctabs">
      <div class="ctab active" onclick="showFTab('fcontent')" id="fct-fcontent">Content</div>
      <div class="ctab" onclick="showFTab('fhistory')" id="fct-fhistory">History <span class="badge">${fl.commits.length}</span></div>
    </div>
    <div class="tab-pane active" id="tab-fcontent">
      ${diffToolbar()}
      <div class="diff-file"><div class="diff-body ${wrapMode?'wrap-mode':''}"><div class="diff-inner dtw" id="fc-inner" style="font-size:${diffFontSize}px">`;

    if (isLarge) {
      const id = 'fc';
      fileDataMap[id] = {
        segs: lines.map((l,i) => ({t:'l', l:{type:'ctx',content:l}, oN:'', nN:i+1})),
        rendered: 0
      };
      h += renderSegs(fileDataMap[id].segs, 0, CHUNK) + sentinel(id);
    } else {
      lines.forEach((l,i) => {
        h += `<div class="dl ctx"><div class="ln" style="width:50px">${i+1}</div><div class="lc">${EH(l)}</div><button class="clb" onclick="copyText(${JSON.stringify(l)})" title="Copy line">‚éò</button></div>`;
      });
    }
    h += `</div></div></div></div>
    <div class="tab-pane" id="tab-fhistory">${fl.commits.map(c=>commitRow(c)).join('')}</div>`;
    setMain(h);
    setTimeout(observeSentinels, 0);
  } catch(e) {
    setMain(`<div class="empty"><h3>Failed to load file</h3><p>${e.message}</p></div>`);
  }
}
function showFTab(id) {
  document.querySelectorAll('.tab-pane').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.ctab').forEach(e=>e.classList.remove('active'));
  _id('tab-'+id)?.classList.add('active');
  _id('fct-'+id)?.classList.add('active');
}
async function showBlame(path) {
  setMain(loadingHtml(`Running blame on ${path}‚Ä¶`));
  try {
    const r = await fetch(`/api/blame?path=${encodeURIComponent(path)}`);
    const d = await r.json();
    let h = backBtn(`showFileView('${ea(path)}')`);
    h += `<div style="font-size:13px;font-weight:600;margin-bottom:10px">Blame ‚Äî ${E(path)}</div>`;
    h += diffToolbar();
    h += `<div class="diff-file"><div class="diff-body"><div class="diff-inner dtw" style="font-size:${diffFontSize}px"><table class="blame-table">`;
    d.blame.forEach((l,i) => {
      h += `<tr>
        <td class="bl-hash" onclick="showCommit('${l.hash}')">${l.meta.short_hash||''}</td>
        <td class="bl-author">${E(l.meta.author||'')}</td>
        <td class="bl-date">${E(l.meta.date||'')}</td>
        <td class="bl-ln">${i+1}</td>
        <td class="bl-code">${EH(l.content)}</td>
      </tr>`;
    });
    h += `</table></div></div></div>`;
    setMain(h);
  } catch(e) {
    setMain(`<div class="empty"><h3>Blame failed</h3><p>${e.message}</p></div>`);
  }
}

// ================================================================
// COMPARE
// ================================================================
function showCompare() {
  if (!DATA) return;
  const refs = DATA.all_refs.map(r=>r.name);
  const refOpts = refs.map(r=>`<option value="${E(r)}">${E(r)}</option>`).join('');
  let h = backBtn('showOverview()');
  h += `<div class="section-title">Compare Refs</div>
  <div class="compare-form">
    <div><div style="font-size:11px;color:var(--text2);margin-bottom:4px">Base</div>
    <input id="cmpBase" list="cmpRefList" placeholder="branch, tag or SHA" value="${E(DATA.repo.current_branch)}"></div>
    <div style="font-size:18px;font-weight:700;padding-bottom:2px;color:var(--text3)">‚Üí</div>
    <div><div style="font-size:11px;color:var(--text2);margin-bottom:4px">Compare</div>
    <input id="cmpCompare" list="cmpRefList" placeholder="branch, tag or SHA"></div>
    <datalist id="cmpRefList">${refOpts}</datalist>
    <div style="display:flex;align-items:flex-end"><button class="btn primary" onclick="runCompare()">Compare ‚Üí</button></div>
  </div>
  <div id="compareResult"><div style="color:var(--text2);font-size:13px">Enter two refs and click Compare.</div></div>`;
  setMain(h);
}
function showCompareWith(base, compare) {
  showCompare();
  setTimeout(() => { const b=_id('cmpBase'),c=_id('cmpCompare');if(b)b.value=base;if(c)c.value=compare;runCompare(); }, 100);
}
async function runCompare() {
  const base=_id('cmpBase')?.value.trim(), compare=_id('cmpCompare')?.value.trim();
  if (!base||!compare){notify('Enter both refs','err');return;}
  const res=_id('compareResult');
  if (res) res.innerHTML = loadingHtml('Comparing‚Ä¶');
  try {
    const r = await fetch(`/api/range-diff?base=${encodeURIComponent(base)}&compare=${encodeURIComponent(compare)}`);
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    let h = `<div class="diff-summary"><b>${E(base)}</b> ‚Üí <b>${E(compare)}</b> ¬∑ ${d.commits.length} commits ¬∑ <span style="color:var(--add-text)">+${d.diff.total_additions}</span> <span style="color:var(--del-text)">-${d.diff.total_deletions}</span></div>`;
    if (d.commits.length) {
      h += `<div class="section-title" style="margin-bottom:8px">Commits in range <span class="cnt">${d.commits.length}</span></div>`;
      h += d.commits.map(c=>`<div class="commit-item" onclick="showCommit('${c.hash}')">
        <div class="av" style="background:${avatarColor(c.author)};font-size:11px;width:26px;height:26px">${avatarInit(c.author)}</div>
        <div class="ci-info"><div class="ci-sub">${E(c.subject)}</div><div class="ci-meta">${E(c.author)} ¬∑ ${E(c.relative)}</div></div>
        <div class="ci-hash">${c.short_hash}</div>
      </div>`).join('');
      h += `<div style="margin-top:14px"></div>`;
    }
    if (d.diff.total_files) { h += `<div class="section-title">Changed Files <span class="cnt">${d.diff.total_files}</span></div>${diffSummaryBar(d.diff)}${diffToolbar()}${renderDiffFiles(d.diff.files,'cmp')}`; }
    else { h += `<div class="empty"><h3>No differences</h3><p>These refs are identical.</p></div>`; }
    if (res) res.innerHTML = h;
    setTimeout(observeSentinels, 0);
  } catch(e) {
    if (res) res.innerHTML = `<div class="empty"><h3>Compare failed</h3><p>${e.message}</p></div>`;
  }
}

// ================================================================
// STASH
// ================================================================
async function showStash(ref) {
  setMain(loadingHtml(`Loading stash ${ref}‚Ä¶`));
  try {
    const r = await fetch(`/api/stash?ref=${encodeURIComponent(ref)}`);
    const d = await r.json();
    let h = backBtn('showOverview()') + `<div class="section-title">Stash: ${E(ref)}</div>`;
    if (d.diff.total_files) { h += diffSummaryBar(d.diff) + diffToolbar() + renderDiffFiles(d.diff.files,'stash'); }
    else { h += `<div class="empty">Empty stash</div>`; }
    setMain(h);
    setTimeout(observeSentinels, 0);
  } catch(e) {
    setMain(`<div class="empty"><h3>Failed to load stash</h3><p>${e.message}</p></div>`);
  }
}

// ================================================================
// REFRESH
// ================================================================
async function refreshData() {
  notify('üîÑ Refreshing‚Ä¶');
  try {
    await fetch('/api/refresh');
    const r = await fetch('/api/data');
    DATA = await r.json();
    commitCache = {};
    Object.keys(fileDataMap).forEach(k => delete fileDataMap[k]);
    hydrate();
    showOverview();
    notify('‚úÖ Refreshed!','ok');
  } catch(e) { notify('‚ùå Refresh failed','err'); }
}

// ================================================================
// HELPERS
// ================================================================
function setMain(html) {
  _id('main').innerHTML = html;
  // Apply current font size to all diff tables
  _id('main').querySelectorAll('.dtw').forEach(el => el.style.fontSize = diffFontSize + 'px');
  // Apply wrap mode
  if (wrapMode) _id('main').querySelectorAll('.diff-body').forEach(b => b.classList.add('wrap-mode'));
}
function _id(id) { return document.getElementById(id); }
function loadingHtml(msg) { return `<div class="loading"><div class="spinner"></div><div>${E(msg)}</div></div>`; }
function backBtn(onclick) { return `<div class="back-btn" onclick="${onclick}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> Back</div>`; }
function E(s) { if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function EH(s) { if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function ea(s) { return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

function notify(msg, type='') {
  const el = _id('notif');
  el.textContent = msg; el.className = `notif show ${type}`;
  clearTimeout(el._t); el._t = setTimeout(() => el.classList.remove('show'), 2800);
}

async function copyText(text) {
  try { await navigator.clipboard.writeText(text); }
  catch(e) { const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta); }
  notify('üìã Copied!','ok');
}

const AV_COLORS=['#1e88e5','#43a047','#e53935','#8e24aa','#f4511e','#00897b','#d81b60','#3949ab','#c0ca33','#00acc1'];
function avatarColor(name) { if(!name)return'#555';let h=0;for(let i=0;i<name.length;i++)h=(h*31+name.charCodeAt(i))&0xffffffff;return AV_COLORS[Math.abs(h)%AV_COLORS.length]; }
function avatarInit(name) { if(!name)return'?';return name.trim().split(/\s+/).map(w=>w[0]).join('').slice(0,2).toUpperCase(); }

// ================================================================
// KEYBOARD SHORTCUTS
// ================================================================
document.addEventListener('keydown', e => {
  if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
  if (e.key==='Escape') showOverview();
  if ((e.metaKey||e.ctrlKey)&&e.key==='r'){e.preventDefault();refreshData();}
  if ((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();showCompare();}
  if ((e.metaKey||e.ctrlKey)&&e.key==='\\'){e.preventDefault();toggleSidebar();}
  if ((e.metaKey||e.ctrlKey)&&e.key==='='){e.preventDefault();zoomIn();}
  if ((e.metaKey||e.ctrlKey)&&e.key==='-'){e.preventDefault();zoomOut();}
  if ((e.metaKey||e.ctrlKey)&&e.key==='0'){e.preventDefault();zoomReset();}
});

// ================================================================
// PINCH TO ZOOM (mobile)
// ================================================================
let pinchD0 = 0, pinchFs0 = 12;
document.addEventListener('touchstart', e => {
  if (e.touches.length===2) {
    pinchD0 = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    pinchFs0 = diffFontSize;
  }
},{passive:true});
document.addEventListener('touchmove', e => {
  if (e.touches.length===2) {
    const d = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    applyFontSize(Math.round(pinchFs0 * (d/pinchD0)));
  }
},{passive:true});
</script>
</body>
</html>
